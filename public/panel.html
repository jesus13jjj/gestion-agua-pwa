<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel ‚Äì AguaComunidad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192">
  <link rel="stylesheet" href="index.css">

  <style>
    body{background:#f5f7fa;font-family:Inter,system-ui,Arial,sans-serif}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:14px 0}
    .kpi{background:#fff;border-radius:12px;padding:14px;border:1px solid #e6edf5}
    .kpi h4{margin:0 0 6px 0;color:#64748b;font-size:14px}
    .kpi .num{font-size:28px;font-weight:800}
    .kpi small{color:#64748b}
    .board{display:grid;grid-template-columns:1.4fr .8fr;gap:16px}
    @media (max-width: 1000px){ .board{grid-template-columns:1fr} }
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .container{max-width:1040px;margin:0 auto;padding:20px}
    .nav{display:flex;justify-content:space-between;align-items:center;padding:14px 0}
    .brand{color:#0ea5e9;text-decoration:none;font-weight:700}
    .muted{color:#666}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
    .badge.admin{background:#fdecea;color:#b71c1c}
    .badge.miembro{background:#e8f4fd;color:#0d47a1}
    .badge.moderador{background:#fff7ed;color:#a24d00}
    .btn{padding:10px 14px;border:none;border-radius:8px;background:#0288d1;color:#fff;cursor:pointer}
    .btn.secondary{background:#e53935}
    .tabs button{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    .tabs button.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    pre{background:#0b1020;color:#e6f1ff;padding:12px;border-radius:8px;overflow:auto}
    canvas{width:100%;height:280px;max-height:280px}
    .list{list-style:none;padding:0;margin:0}
    .list li{padding:10px;border-bottom:1px dashed #e6edf5;display:flex;justify-content:space-between;gap:12px}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .pill.warn{background:#fff7ed;color:#a24d00}
    .pill.danger{background:#fdecea;color:#b71c1c}
    .pill.ok{background:#e8f4fd;color:#0d47a1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e6edf5;text-align:left;font-size:14px}
    th{font-weight:800;color:#475569}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:2000;padding:16px}
    .modal{background:#fff;color:#222;border-radius:10px;max-width:720px;width:100%;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
    .modal h3{margin:0 0 8px}
    .modal .close{background:transparent;border:none;font-size:18px;cursor:pointer;float:right}
    .modal.show{display:flex}
    .muted-dark{color:#6b7280}
  </style>
</head>

<body>
  <div class="container">
    <div class="nav">
      <a class="brand" href="info.html">AguaComunidad</a>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="userBadge" class="badge">...</span>
        <button class="btn secondary" id="logout">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:14px;flex-wrap:wrap">
        <div>
          <h2>Panel de AguaComunidad</h2>
          <div id="subtitle" class="muted">Sesi√≥n actual</div>
        </div>
        <div class="tabs">
          <button class="tab active" data-range="day">Hoy</button>
          <button class="tab" data-range="week">Semana</button>
          <button class="tab" data-range="month">Mes</button>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <h4 id="kpi-title-main">Consumo de hoy</h4>
          <div class="num" id="kpi-today">-- L</div>
          <small id="kpi-today-sub">Actualizando...</small>
        </div>
        <div class="kpi">
          <h4 id="kpi-title-avg">Promedio semanal</h4>
          <div class="num" id="kpi-week">-- L/d√≠a</div>
          <small id="kpi-week-sub">Actualizando...</small>
        </div>
        <div class="kpi">
          <h4>Alertas activas</h4>
          <div class="num" id="kpi-alerts">--</div>
          <small id="kpi-alerts-sub">Actualizando...</small>
        </div>
      </div>

      <div class="board">
        <div class="card">
          <h3>Gr√°fica de consumo</h3>
          <canvas id="chart"></canvas>
          <small class="muted">Litros por periodo seleccionado</small>
        </div>

        <div class="card">
          <h3>Alertas recientes</h3>
          <ul class="list" id="alertsList">
            <li class="muted" style="justify-content:center">Cargando...</li>
          </ul>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Reportes / Lecturas</h3>
          <button id="btn-report" class="btn">Reportar incidencia</button>
        </div>

        <table>
          <thead>
            <tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Estado</th></tr>
          </thead>
          <tbody id="reportsTbody">
            <tr><td colspan="4" class="muted">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <details style="margin-top:10px">
        <summary>Ver JSON de la sesi√≥n</summary>
        <pre id="info">Cargando usuario...</pre>
      </details>

      <div id="adminSection" class="card" style="background:#fdecea;color:#7f1d1d;display:none">
        <h3>üîë Panel de administraci√≥n</h3>
        <p>Acciones para administradores.</p>
      </div>

      <div id="memberSection" class="card" style="background:#e0f7fa;color:#064e3b;display:none">
        <h3>üë§ √Årea de miembro</h3>
        <p>Incidencias y sensores asignados.</p>
      </div>
    </div>

    <div class="footer" style="margin:24px 0;color:#666;text-align:center">
      ¬© 2025 AguaComunidad
    </div>
  </div>

  <!-- Modal Report -->
  <div id="reportModal" class="modal-overlay">
    <div class="modal">
      <button class="close" id="closeReportModal">‚úï</button>
      <h3>Reportar incidencia</h3>
      <form id="reportForm">
        <label class="muted-dark">Tipo</label>
        <input id="report-type" required style="width:100%;padding:8px;margin:6px 0;border:1px solid #e5e7eb;border-radius:6px">

        <label class="muted-dark">Detalle</label>
        <textarea id="report-detail" required style="width:100%;padding:8px;margin:6px 0;border:1px solid #e5e7eb;border-radius:6px" rows="4"></textarea>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button type="button" class="btn secondary" id="cancelReport">Cancelar</button>
          <button type="submit" class="btn">Enviar</button>
        </div>
      </form>
    </div>
  </div>

<script>
  const API = 'http://localhost:3001';
  const token = localStorage.getItem('token');
  const $ = sel => document.querySelector(sel);

  function pill(status){
    if(status==='cr√≠tica') return '<span class="pill danger">cr√≠tica</span>';
    if(status==='advertencia') return '<span class="pill warn">advertencia</span>';
    return '<span class="pill ok">ok</span>';
  }

  /* ======================= GRAFICA ======================= */
  function drawLineChart(canvas, labels, values){
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.clientWidth;
    const h = canvas.height = 280;
    ctx.clearRect(0,0,w,h);

    if (!labels.length){
      ctx.fillStyle="#64748b";
      ctx.font = "14px Arial";
      ctx.fillText("No hay datos", 20, h/2);
      return;
    }

    const pad = 28;
    const max = Math.max(...values, 10);
    const min = 0;

    const points = [];
    if (labels.length === 1) {
      const x = w / 2;
      const y = h - pad - (values[0]-min) * (h-pad*2) / (max-min || 1);
      points.push({ x, y });
    } else {
      const stepX = (w - pad*2) / (labels.length-1);
      values.forEach((v,i)=>{
        const x = pad + i*stepX;
        const y = h - pad - (v-min) * (h-pad*2) / (max-min || 1);
        points.push({ x, y });
      });
    }

    // Ejes
    ctx.strokeStyle="#e2e8f0";
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, h-pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.stroke();

    // L√≠nea
    if (points.length > 1) {
      ctx.strokeStyle="#0ea5e9";
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p,i)=>{
        if(i===0) ctx.moveTo(p.x,p.y);
        else ctx.lineTo(p.x,p.y);
      });
      ctx.stroke();
    }

    // Puntos
    ctx.fillStyle="#0288d1";
    points.forEach(p=>{
      ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
    });
  }

  /* ======================= CARGAR SESI√ìN ======================= */
  async function loadSession(){
    if (!token) { location.href="./index.html"; return; }
    try{
      const res = await fetch(`${API}/auth/me`, {
        headers:{ Authorization:'Bearer '+token }
      });
      if(res.status===401){
        localStorage.removeItem('token');
        location.href="./index.html";
        return;
      }
      const data = await res.json();

      $('#info').textContent = JSON.stringify(data, null, 2);

      const u = data.user || {};
      const chip = u.role_name || 'miembro';

      $('#subtitle').innerHTML =
        `${u.full_name || u.email} <span class="badge ${chip}">${chip}</span>`;
      $('#userBadge').className = 'badge '+chip;
      $('#userBadge').textContent = chip;

      if(chip === "administrador") $('#adminSection').style.display="block";
      else $('#memberSection').style.display="block";

    }catch(err){ console.error(err); }
  }

  /* ======================= M√âTRICAS ======================= */
  async function loadMetrics(range = "day") {
    try {
      const res = await fetch(`${API}/api/dashboard/metrics?range=${range}`, {
        headers: { Authorization: "Bearer " + token },
      });

      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();

      // -------- KPIs ----------
      const litrosTotal = Number(data.today?.litros ?? 0);
      const promedio = Number(data.week?.promedio ?? 0);
      const totalAlertas = data.alerts?.count ?? 0;

      // T√≠tulos seg√∫n rango
      if (range === "day") {
        $("#kpi-title-main").textContent = "Consumo de hoy";
        $("#kpi-title-avg").textContent = "Promedio diario";
      } else if (range === "week") {
        $("#kpi-title-main").textContent = "Consumo de la semana";
        $("#kpi-title-avg").textContent = "Promedio semanal";
      } else {
        $("#kpi-title-main").textContent = "Consumo del mes";
        $("#kpi-title-avg").textContent = "Promedio diario del mes";
      }

      // Valores
      $("#kpi-today").textContent = litrosTotal.toFixed(1) + " L";
      $("#kpi-today-sub").textContent = "Actualizado";

      $("#kpi-week").textContent = promedio.toFixed(1) + " L/d√≠a";
      $("#kpi-week-sub").textContent = "Actualizado";

      $("#kpi-alerts").textContent = totalAlertas;
      $("#kpi-alerts-sub").textContent = "Actualizado";

      // -------- Gr√°fica ----------
      const history = data.history || [];
      const labels = history.map(h =>
        h.label != null
          ? String(h.label)
          : (h.hora != null ? `${h.hora}:00` : "")
      );
      const series = history.map(h => Number(h.litros ?? 0));

      drawLineChart($("#chart"), labels.filter(l => l !== ""), series);

      // -------- Alertas recientes ----------
      const ul = $("#alertsList");
      const items = data.alerts?.items || [];

      if (!items.length) {
        ul.innerHTML =
          '<li class="muted" style="justify-content:center">Sin alertas</li>';
      } else {
        ul.innerHTML = items
          .map(
            (r) => `
          <li>
            <div>
              <strong>${r.nivel.toUpperCase()}</strong>
              <div class="muted">
                ${r.porcentaje}% ‚Äì ${new Date(r.timestamp).toLocaleString()}
              </div>
            </div>
            ${
              r.nivel === "critico"
                ? '<span class="pill danger">cr√≠tica</span>'
                : r.nivel === "bajo"
                ? '<span class="pill warn">baja</span>'
                : '<span class="pill ok">ok</span>'
            }
          </li>`
          )
          .join("");
      }
    } catch (err) {
      console.error("Error cargando m√©tricas:", err);

      $("#kpi-today-sub").textContent = "Error al cargar";
      $("#kpi-week-sub").textContent = "Error al cargar";
      $("#kpi-alerts-sub").textContent = "Error al cargar";
      $("#alertsList").innerHTML =
        '<li class="muted" style="justify-content:center">No se pudo cargar</li>';
    }
  }

  /* ======================= REPORTES ======================= */
  async function loadReports(){
    try{
      const res = await fetch(`${API}/api/reports?limit=10`, {
        headers:{ Authorization:'Bearer '+token }
      });
      const rows = await res.json();
      const tbody = $('#reportsTbody');

      tbody.innerHTML = rows.length ?
        rows.map(r => `
          <tr>
            <td>${r.date}</td>
            <td>${r.type}</td>
            <td>${r.detail}</td>
            <td>${r.status}</td>
          </tr>`).join('')
        : `<tr><td colspan="4" class="muted">Sin reportes</td></tr>`;
    }catch(err){
      $('#reportsTbody').innerHTML =
        `<tr><td colspan="4" class="muted">Error</td></tr>`;
    }
  }

  /* ======================= GUARDAR REPORTE ======================= */
  async function saveReport(){
    const type = $('#report-type').value.trim();
    const detail = $('#report-detail').value.trim();

    if(!type || !detail){
      alert("Llena todos los campos");
      return;
    }

    try{
      const res = await fetch(`${API}/api/reports`, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          Authorization:"Bearer "+token
        },
        body:JSON.stringify({ type, detail })
      });

      if(!res.ok) throw new Error("fail");

      alert("Reporte enviado ‚úî");
      closeModal();
      loadReports();

    }catch(err){
      alert("Error al guardar el reporte");
    }
  }

  /* ======================= MODAL ======================= */
  const modal = $('#reportModal');

  function openModal(){ modal.style.display="flex"; }
  function closeModal(){ modal.style.display="none"; }

  $('#btn-report').onclick = openModal;
  $('#closeReportModal').onclick = closeModal;
  $('#cancelReport').onclick = closeModal;

  $('#reportForm').onsubmit = e=>{
    e.preventDefault();
    saveReport();
  };

  /* ======================= TABS ======================= */
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      loadMetrics(btn.dataset.range);
    };
  });

  /* ======================= CERRAR SESI√ìN ======================= */
  $('#logout').onclick = ()=>{
    localStorage.removeItem('token');
    location.href="./index.html";
  };

  /* ======================= INICIO ======================= */
  loadSession();
  loadMetrics("day");
  loadReports();
</script>
</body>
</html>
